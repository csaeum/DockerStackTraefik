# traefik-dynamic.yaml - Traefik - START
# ========================================
# HTTP Middlewares (Wiederverwendbare Bausteine)
# ========================================
http:
  middlewares:
    # ========================================
    # Authentication (Legacy - nicht mehr genutzt)
    # ========================================
    # Hinweis: Dashboard-Auth erfolgt jetzt über docker-compose.yaml Labels mit Env-Vars
    # Diese Middleware wird nicht mehr verwendet, bleibt aber für Referenz
    dashboard-auth:
      basicAuth:
        users:
          - "traefik-admin:$$apr1$$CHANGE_ME$$CHANGE_ME"
        removeHeader: false
        realm: "Traefik Dashboard"

    # ========================================
    # Redirects
    # ========================================
    redirect-to-https:
      redirectScheme:
        scheme: https
        permanent: true

    redirect-to-www:
      redirectRegex:
        regex: "^(https?://)(?:www\\.)?(.+)"
        replacement: "${1}www.${2}"
        permanent: true

    # ========================================
    # Geo-Blocking
    # ========================================
    geo-block:
      plugin:
        geoblock:
          allowLocalRequests: true
          allowUnknownCountries: false
          api: https://get.geojs.io/v1/ip/country/{ip}
          apiTimeoutMs: 150
          cacheSize: 200
          countries:
            - RU  # Russland
            - CN  # China
            - IR  # Iran
            - IN  # Indien
            - PK  # Pakistan
            - BD  # Bangladesch
            - ID  # Indonesien
            - SG  # Singapur
            - PH  # Philippinen
            - VN  # Vietnam
            - TH  # Thailand
            - MY  # Malaysia
            - KR  # Südkorea
            - KZ  # Kasachstan
            - HK  # Hongkong
            - TW  # Taiwan
            - AE  # VAE
            - QA  # Katar
            - SA  # Saudi-Arabien
            - JP  # Japan
            - NP  # Nepal
            - LK  # Sri Lanka
          blackListMode: true
          httpStatusCodeDeniedRequest: 403
          logAllowedRequests: false
          logApiRequests: true
          logLocalRequests: false
          silentStartUp: false

    # ========================================
    # Rate Limiting & DoS Protection
    # ========================================
    rate-limit:
      rateLimit:
        average: 100
        burst: 50
        period: 1s

    in-flight-limit:
      inFlightReq:
        amount: 100
        sourceCriterion:
          ipStrategy:
            depth: 1

    # ========================================
    # Security Headers
    # ========================================
    security-headers:
      headers:
        frameDeny: true
        contentTypeNosniff: true
        browserXssFilter: true
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
        referrerPolicy: "strict-origin-when-cross-origin"
        permissionsPolicy: "geolocation=(), microphone=(), camera=()"

    # ========================================
    # Performance
    # ========================================
    compression:
      compress:
        excludedContentTypes:
          - "text/event-stream"

  # ========================================
  # HTTP Routers
  # ========================================
  routers:
    # ========================================
    # Ping / Health Check Router
    # ========================================
    ping:
      entryPoints:
        - websecure-https
      rule: "Path(`/ping`)"
      service: "ping@internal"

    # ========================================
    # Mailcow ACME Challenge Router
    # ========================================
    # Hinweis: Dieser Router ermöglicht es Mailcow, Let's Encrypt Zertifikate
    # über Traefik zu erhalten. Nur auf Servern mit Mailcow aktiv.
    # Die Domains werden über .env konfiguriert (MAILCOW_ACME_DOMAINS)
    mailcow-acme-challenge:
      entryPoints:
        - web-http
      rule: "(Host(`autodiscover.clicklocal.de`) || Host(`autoconfig.clicklocal.de`) || Host(`autodiscover.familie-saeum.de`) || Host(`autoconfig.familie-saeum.de`) || Host(`autodiscover.lichte-kraft.eu`) || Host(`autoconfig.lichte-kraft.eu`) || Host(`autodiscover.web-seo-consulting.eu`) || Host(`autoconfig.web-seo-consulting.eu`) || Host(`mail.web-seo-consulting.eu`) || Host(`autodiscover.wunschschreiner.eu`) || Host(`autoconfig.wunschschreiner.eu`)) && PathPrefix(`/.well-known/acme-challenge/`)"
      service: mailcow-acme
      priority: 1000

  # ========================================
  # HTTP Services
  # ========================================
  services:
    # ========================================
    # Mailcow ACME Service
    # ========================================
    # Hinweis: Zeigt auf den Mailcow NGINX Container.
    # Der Container muss im gleichen Netzwerk sein (traefik_proxy_network)
    mailcow-acme:
      loadBalancer:
        servers:
          - url: "http://mailcow-nginx-mailcow-1:8080"

# ========================================
# TLS Options
# ========================================
tls:
  options:
    modern:
      minVersion: "VersionTLS13"
      sniStrict: true
      cipherSuites:
        - "TLS_AES_128_GCM_SHA256"
        - "TLS_AES_256_GCM_SHA384"
        - "TLS_CHACHA20_POLY1305_SHA256"
# traefik-dynamic.yaml - Traefik - ENDE
