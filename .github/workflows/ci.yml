name: CI - Docker Stack Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate-compose:
    name: Validate Docker Compose
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env from example
        run: cp .env.example .env

      - name: Validate docker-compose.yaml
        run: docker compose config --quiet

      - name: Check docker-compose syntax
        run: docker compose config > /dev/null

  yaml-lint:
    name: YAML Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: YAML Lint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: |
            docker-compose.yaml
            configs/traefik.yaml
            configs/traefik-dynamic.yaml
            .github/workflows/
          config_data: |
            extends: default
            rules:
              line-length:
                max: 120
                level: warning
              comments:
                min-spaces-from-content: 1

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  config-test:
    name: Configuration Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env from example
        run: cp .env.example .env

      - name: Test environment variable substitution
        run: |
          docker compose config | grep "COMPOSE_PROJECT_NAME"
          docker compose config | grep "traefik"

      - name: Verify network configuration
        run: |
          docker compose config | grep "traefik_proxy_network"

      - name: Check volumes configuration
        run: |
          docker compose config | grep -A 5 "volumes:"

  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Markdown Lint
        uses: nosborn/github-action-markdown-cli@v3.3.0
        with:
          files: .
          config_file: .markdownlint.json
          ignore_files: node_modules/
